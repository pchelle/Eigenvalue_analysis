name: EVANS Pipeline

on:
  workflow_dispatch:
    inputs:
      input_molecules:
        description: 'Path to input molecules (SDF or MOL2 format)'
        required: false
        default: 'test_molecules'
      run_simulations:
        description: 'Run molecular simulations step'
        required: false
        default: 'true'
        type: boolean
      run_distance_calc:
        description: 'Run distance calculation step'
        required: false
        default: 'true'
        type: boolean
      run_eigenvalue_calc:
        description: 'Run eigenvalue calculation step'
        required: false
        default: 'true'
        type: boolean
      run_ml_model:
        description: 'Run ML model building step'
        required: false
        default: 'true'
        type: boolean
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  evans-analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Amber
        shell: bash
        run: |
          conda create -n amber -c conda-forge ambertools=23
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas matplotlib scikit-learn mlxtend
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.0'
      
      - name: Step 1 - Molecular Simulations (AMBER)
        if: ${{ github.event.inputs.run_simulations != 'false' }}
        run: |
          echo "Make Amber scripts as executable"
          chmod +x "molecular simulations/no_conect.sh"
          chmod +x "molecular simulations/auto-antechamber.sh"
          chmod +x "molecular simulations/autoleap.sh"
          chmod +x "molecular simulations/runMin.sh"
          chmod +x "molecular simulations/remin.sh"
          echo "Run Amber scripts"
          "./molecular simulations/auto-antechamber.sh"
          "./molecular simulations/autoleap.sh"
          "./molecular simulations/runMin.sh"
          "./molecular simulations/remin.sh"
      
      - name: Step 2 - Distance Calculation (VMD)
        if: ${{ github.event.inputs.run_distance_calc != 'false' }}
        run: |
          echo "Make VMD script as executable"
          chmod +x "Distance calculation/dist_CentBond-CentMol.tcl"
          echo "Run VMD script"
          "./Distance calculation/dist_CentBond-CentMol.tcl"
      
      - name: Step 3 - Matrix Generation and Processing
        run: |
          echo "Make VMD script as executable"
          chmod +x "matrix generation and processing/Evans_v2020.1.xlsm"
          echo "Run VMD script"
          -e "./matrix generation and processing/Evans_v2020.1.xlsm"
      
      - name: Step 4 - Eigenvalue Calculation (R)
        if: ${{ github.event.inputs.run_eigenvalue_calc != 'false' }}
        run: |
          -e Rscript "./Eigenvalue descriptors/newCoVarMats_2_eigen_tab.r"
      
      - name: Step 5 - ML Model Building (Python)
        if: ${{ github.event.inputs.run_ml_model != 'false' }}
        run: |
          -e python "./ML model building/classification.py"
          -e python "./ML model building/regression.py"
          
